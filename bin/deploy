#!/bin/bash

# Check if current path equals ~/lean, exit if not
EXPECTED_PATH="$HOME/lean"
CURRENT_PATH=$(pwd)
if [[ "$CURRENT_PATH" != "$EXPECTED_PATH" ]]; then
  echo -e "\033[0;31mScript must be run under ~/lean directory\033[0m"
  echo -e "\033[0;35mCurrent path: $CURRENT_PATH; Expected path: $EXPECTED_PATH\033[0m"
  exit 0
fi

if [ -z "$1" ]; then
  echo "Please specify the account name! e.g. LifelongPaper"
  exit 1
fi

ACCOUNT=$1
# Remove the last slash /
if [[ $ACCOUNT == */ ]]; then
  ACCOUNT=${ACCOUNT////}
  # ACCOUNT=$(echo "$ACCOUNT" | sed 's/.$//')
fi

# Double check confirm dialog
read -p "Are you sure to deploy/redeploy ${ACCOUNT} (y/n)? " -n 1 -r
echo # (optional) move to a new line
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  exit 2
fi

echo "Deploying/Redeploying ${ACCOUNT}..."

MAIN_CODE=main.py
CONFIG_FILE=config.json
SET_API_TOKEN=true

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
LIVE_DIR=$(dirname "${SCRIPT_DIR}")/live
PROJECT_DIR=$(dirname "${LIVE_DIR}")
ACCOUNT_CONFIG="${LIVE_DIR}"/${ACCOUNT}
ACCOUNT_PROJECT="$(dirname "${PROJECT_DIR}")"/${ACCOUNT}

if [ ! -d "${ACCOUNT_CONFIG}" ]; then
  echo "Directory ${ACCOUNT_CONFIG} DOES NOT exists!"
  exit 3
fi

# Confirm setting gridInitializeSession: True
MATCHED_LINE=$(grep -E -n "^\s*LIConfigKey\.(gridInitializeSession)\s*:\s*True", "${ACCOUNT_CONFIG}"/${MAIN_CODE})
if [ -n "${MATCHED_LINE}" ]; then
  read -p "Are you sure to !!!LIQUIDATE!!! this strategy as #${MATCHED_LINE} (y/n)? " -n 1 -r
  echo # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 4
  fi
fi

# Load account credentials/keys
# shellcheck disable=SC1090
source ~/lean/secret/"${ACCOUNT}".key

# Login QuantConnect user if required
if [ -n "${QC_USER}" ]; then
  source "${SCRIPT_DIR}"/login "${QC_USER}"
fi

# Set API token to access website REST API if required
if [ "$SET_API_TOKEN" = true ]; then
  METADATA_KEY="global/webApiToken"
  "${SCRIPT_DIR}"/set-api-token "${METADATA_KEY}" "${WEB_API_USER}" "${WEB_API_PWD}" true
fi

# Go back to lean home dir
cd "${PROJECT_DIR}"/.. || exit

# Sync to live project dir
rsync -a --delete --exclude-from="${PROJECT_DIR}"/.leanignore "${PROJECT_DIR}"/ "${ACCOUNT_PROJECT}"/

# Copy over main/config files
cp "${ACCOUNT_CONFIG}"/${MAIN_CODE} "${ACCOUNT_PROJECT}"/${MAIN_CODE}
cp "${ACCOUNT_CONFIG}"/${CONFIG_FILE} "${ACCOUNT_PROJECT}"/${CONFIG_FILE}

# Push local changes to cloud
lean cloud push --project "${ACCOUNT}"
# Pull cloud code back to local
lean cloud pull --project "${ACCOUNT}"

status=$(lean cloud status "${ACCOUNT}")
echo "Checking project ${ACCOUNT} status: "
echo "$status"

RETRY_SLEEP_SECONDS=15
while [[ $status == *"Live status: Running"* ]]
do
  echo -e "\033[0;35mStopping current live project in $RETRY_SLEEP_SECONDS seconds...\033[0m"
  lean cloud live stop "${ACCOUNT}"
  sleep $RETRY_SLEEP_SECONDS # Sleep a few seconds
  status=$(lean cloud status "${ACCOUNT}")
  echo "Checking project ${ACCOUNT} status: "
  echo "$status"
done

echo -e "\033[0;35mDeploying ${ACCOUNT} to QuantConnect cloud now...\033[0m"
while true; do
  status=$(lean cloud live deploy "${ACCOUNT}" \
    --node "${ACCOUNT}" \
    --auto-restart yes \
    --notify-insights no \
    --notify-order-events no \
    --brokerage "Interactive Brokers" \
    --data-provider-live "${DATA_PROVIDER:-QuantConnect}" \
    --ib-weekly-restart-utc-time "22:00:00" \
    --ib-account "${ACCOUNT_ID}" \
    --ib-user-name "${USERNAME}" \
    --ib-password "${PASSWORD}")
  # Check if status contains "Deployment completed successfully!"
  seconds=$(echo "$status" | grep -o '[0-9]\+ seconds' | awk '{print $1}')
  # If seconds is empty or 0, break the loop
  if [[ -z "$seconds" || "$seconds" -eq 0 ]]; then
    echo "Deployment completed successfully!"
    break
  fi
  # Otherwise, retry after sleeping for the specified seconds
  echo "$status"
  echo -e "\033[0;35mRetrying deployment in $seconds seconds...\033[0m"
  sleep "$seconds"
done

# Login back to llc
if [[ ${QC_USER} != "llc" ]]; then
  source "${SCRIPT_DIR}"/login llc
fi