#!/bin/bash

# Check if current path equals ~/lean, exit if not
EXPECTED_PATH="$HOME/lean"
CURRENT_PATH=$(pwd)
if [[ "$CURRENT_PATH" != "$EXPECTED_PATH" ]]; then
  echo -e "\033[0;31mScript must be run under ~/lean directory\033[0m"
  echo -e "\033[0;35mCurrent path: $CURRENT_PATH; Expected path: $EXPECTED_PATH\033[0m"
  exit 0
fi

if [ -z "$1" ]; then
  echo "Please specify the account name! e.g. liats, CongTest, LifelongPaper"
  exit 1
fi

ACCOUNT=$1
# Remove the last slash /
if [[ $ACCOUNT == */ ]]; then
  ACCOUNT=${ACCOUNT////}
  # ACCOUNT=$(echo "$ACCOUNT" | sed 's/.$//')
fi

echo -e "\033[0;35mBacktesting ${ACCOUNT}...\033[0m"

MAIN_CODE=main.py
CONFIG_FILE=config.json
SET_API_TOKEN=true
QC_USER=llc # Use llc for backtest by default

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)

LIVE_DIR=$(dirname "${SCRIPT_DIR}")/live
PROJECT_DIR=$(dirname "${LIVE_DIR}")
ACCOUNT_CONFIG="${LIVE_DIR}"/${ACCOUNT}
ACCOUNT_PROJECT="$(dirname "${PROJECT_DIR}")"/${ACCOUNT}

if [ ! -d "${ACCOUNT_CONFIG}" ]; then
  echo "Directory ${ACCOUNT_CONFIG} DOES NOT exists!"
  exit 2
fi

# Load account credentials/keys
# shellcheck disable=SC1090
source ~/lean/secret/"${ACCOUNT}".key

# Login QuantConnect user if required
if [ -n "${QC_USER}" ]; then
  source "${SCRIPT_DIR}"/login "${QC_USER}"
fi

# Set API token to access website REST API if required
if [ "$SET_API_TOKEN" = true ]; then
  METADATA_KEY="global/webApiToken"
  "${SCRIPT_DIR}"/set-api-token "${METADATA_KEY}" "${WEB_API_USER}" "${WEB_API_PWD}" true
fi

# Go back to lean home dir
cd "${PROJECT_DIR}"/.. || exit

# Sync to live project dir
rsync -a --delete --exclude-from="${PROJECT_DIR}"/.leanignore "${PROJECT_DIR}"/ "${ACCOUNT_PROJECT}"/

# Copy over main/config files
cp "${ACCOUNT_CONFIG}"/${MAIN_CODE} "${ACCOUNT_PROJECT}"/${MAIN_CODE}
cp "${ACCOUNT_CONFIG}"/${CONFIG_FILE} "${ACCOUNT_PROJECT}"/${CONFIG_FILE}

# Run backtest on project
lean cloud backtest "${ACCOUNT}" --push

# Login back to llc
if [[ ${QC_USER} != "llc" ]]; then
  source "${SCRIPT_DIR}"/login llc
fi